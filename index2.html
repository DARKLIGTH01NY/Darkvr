<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zangi Private - Fix</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #0b141a; --sidebar: #111b21; --panel: #202c33; --green: #00a884; --my-msg: #005c4b; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #app { display: flex; width: 100%; }
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #0b141a; }
        .contact { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .contact:hover { background: var(--panel); }
        .active { background: var(--panel); border-left: 4px solid var(--green); }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 10px; max-width: 70%; font-size: 15px; word-wrap: break-word; }
        .sent { background: var(--my-msg); align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 2px; }
        .input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #2a3942; color: white; outline: none; }
        button { background: var(--green); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app">
    <div class="sidebar">
        <div style="padding:15px; background:var(--panel)">
            <a href="index.html" style="color:var(--green); text-decoration:none; font-weight:bold;">← Voltar ao Global</a>
        </div>
        <div id="contacts-list"></div>
    </div>
    <div class="chat-main">
        <div style="padding:15px; background:var(--panel); font-weight:bold;" id="chat-header">Selecione um contato</div>
        <div id="chat-window"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Digite uma mensagem..." onkeypress="if(event.key==='Enter') enviar()">
            <button onclick="enviar()" id="btn-envio">Enviar</button>
        </div>
    </div>
</div>

<script>
    // Configuração do seu Firebase (chat-60150)
    const firebaseConfig = {
        apiKey: "AIzaSyDqn7EnXcAh268qzsSR-gdKbuUI-nNYCcw",
        authDomain: "chat-60150.firebaseapp.com",
        projectId: "chat-60150",
        storageBucket: "chat-60150.firebasestorage.app",
        messagingSenderId: "99648585531",
        appId: "1:99648585531:web:c6df81b493219b0f17011e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let target = null;
    let unsubscribeChat = null;

    // Monitor de Segurança: Só carrega dados se houver usuário logado
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            carregarContatos();
        } else {
            window.location.href = "index.html";
        }
    });

    // Carrega contatos salvos na coleção 'contatos' no Firestore
    async function carregarContatos() {
        try {
            db.collection("contatos")
              .where("dono_id", "==", currentUser.uid)
              .onSnapshot(snapshot => {
                const list = document.getElementById('contacts-list');
                list.innerHTML = snapshot.docs.map(doc => {
                    const c = doc.data();
                    const activeClass = target?.id === c.contato_id ? 'active' : '';
                    return `
                        <div class="contact ${activeClass}" onclick="selecionar('${c.contato_id}', '${c.contato_nome}')">
                            <div style="width:35px; height:35px; background:var(--green); border-radius:50%; text-align:center; line-height:35px; font-weight:bold;">
                                ${c.contato_nome[0].toUpperCase()}
                            </div>
                            ${c.contato_nome}
                        </div>
                    `;
                }).join('');
            });
        } catch(e) { console.error("Erro ao carregar contatos:", e); }
    }

    function selecionar(id, nome) {
        target = { id, nome };
        document.getElementById('chat-header').innerText = nome;
        
        // Remove seleção antiga visualmente
        const contacts = document.querySelectorAll('.contact');
        contacts.forEach(c => c.classList.remove('active'));
        
        carregarMensagensPrivadas();
    }

    function carregarMensagensPrivadas() {
        if(!target || !currentUser) return;
        
        // Cancela escuta do chat anterior se houver
        if (unsubscribeChat) unsubscribeChat();

        const win = document.getElementById('chat-window');
        
        // Busca mensagens onde (EU -> ALVO) OU (ALVO -> EU)
        // Segurança: O Firestore garante que você só lê o que as regras permitem
        unsubscribeChat = db.collection("messages_privadas")
            .where('participantes', 'array-contains', currentUser.uid)
            .orderBy("created_at", "asc")
            .onSnapshot(snapshot => {
                const chatHTML = snapshot.docs
                    .map(doc => doc.data())
                    .filter(m => (m.de_id === currentUser.uid && m.para_id === target.id) || 
                                 (m.de_id === target.id && m.para_id === currentUser.uid))
                    .map(m => `
                        <div class="msg ${m.de_id === currentUser.uid ? 'sent' : 'received'}">
                            ${m.mensagem}
                        </div>
                    `).join('');
                
                win.innerHTML = chatHTML;
                win.scrollTop = win.scrollHeight;
            });
    }

    async function enviar() {
        const input = document.getElementById('msg-input');
        const txt = input.value.trim();
        if(!txt || !target || !currentUser) return;

        input.value = "";
        
        try {
            await db.collection("messages_privadas").add({
                de_id: currentUser.uid,
                para_id: target.id,
                participantes: [currentUser.uid, target.id], // Campo para filtro de segurança
                mensagem: txt,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch(e) {
            console.error("Erro ao enviar mensagem segura:", e);
        }
    }
</script>
</body>
  </html>
